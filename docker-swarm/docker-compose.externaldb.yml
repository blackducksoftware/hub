version: '3.6'
# Starting with the 2019.2.0 release: DO NOT EDIT THIS FILE!!!
# ADD ANY OF YOUR OVERRIDES IN THE docker-compose.local-overrides.yml FILE
# Refer to the Release Notes or Installation Guide for more information.

x-common-env-settings: &common-env-settings
  HUB_POSTGRES_IS_EXTERNAL: "true"
  HUB_POSTGRES_PARAMETER_LIMIT: 12000
  HUB_JOBRUNNER_HOST: 'tasks.jobrunner.'
  HUB_SCAN_HOST: 'scanmatch'
  SYNOPSYS_CRYPTO_PROFILE: 'SWARM'

x-host-settings: &host-settings
  HUB_JOBRUNNER_HOST: 'tasks.jobrunner.'
  HUB_SCAN_HOST: 'scanmatch'

x-long-start-period: &long-start-period
  start_period: 14400s

services:
  authentication:
    user: authentication:root
    image: blackducksoftware/blackduck-authentication:2025.10.0
    volumes:
    - authentication-volume:/opt/blackduck/hub/hub-authentication/ldap
    - {type: tmpfs, target: /opt/blackduck/hub/hub-authentication/security}
    env_file: [blackduck-config.env , hub-postgres.env]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/api/health-checks/liveness',
        /opt/blackduck/hub/hub-authentication/security/root.crt, /opt/blackduck/hub/hub-authentication/security/blackduck_system.crt,
        /opt/blackduck/hub/hub-authentication/security/blackduck_system.key]
      interval: 30s
      timeout: 60s
      retries: 15
      << : *long-start-period
    environment:
      << : *common-env-settings
    deploy:
      mode: replicated
      restart_policy: {condition: on-failure, delay: 5s, window: 60s}
  webapp:
    user: webapp:root
    image: blackducksoftware/blackduck-webapp:2025.10.0
    volumes:
    - log-volume:/opt/blackduck/hub/logs
    - {type: tmpfs, target: /opt/blackduck/hub/hub-webapp/security}
    env_file: [blackduck-config.env , hub-postgres.env]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/api/health-checks/liveness',
        /opt/blackduck/hub/hub-webapp/security/root.crt, /opt/blackduck/hub/hub-webapp/security/blackduck_system.crt,
        /opt/blackduck/hub/hub-webapp/security/blackduck_system.key]
      interval: 30s
      timeout: 60s
      retries: 15
      << : *long-start-period
    environment:
      << : *common-env-settings
    deploy:
      mode: replicated
      restart_policy: {condition: on-failure, delay: 5s, window: 60s}
  storage:
    user: storage:root
    image: blackducksoftware/blackduck-storage:2025.10.0
    env_file: [blackduck-config.env , hub-postgres.env]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/api/health-checks/liveness',
        /opt/blackduck/hub/blackduck-storage/security/root.crt, /opt/blackduck/hub/blackduck-storage/security/blackduck_system.crt,
        /opt/blackduck/hub/blackduck-storage/security/blackduck_system.key]
      interval: 30s
      timeout: 60s
      retries: 15
      << : *long-start-period
    environment:
      << : *common-env-settings
    volumes:
    - storage-volume:/opt/blackduck/hub/uploads
    - {type: tmpfs, target: /opt/blackduck/hub/blackduck-storage/security}
    deploy:
      mode: replicated
      restart_policy: {condition: on-failure, delay: 5s, window: 60s}
  jobrunner:
    user: jobrunner:root
    image: blackducksoftware/blackduck-jobrunner:2025.10.0
    env_file: [blackduck-config.env , hub-postgres.env]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/health-checks/liveness',
      /opt/blackduck/hub/jobrunner/security/root.crt, /opt/blackduck/hub/jobrunner/security/blackduck_system.crt,
      /opt/blackduck/hub/jobrunner/security/blackduck_system.key]
      interval: 30s
      timeout: 60s
      retries: 15
      << : *long-start-period
    environment:
      << : *common-env-settings
      org.quartz.scheduler.periodic.maxthreads: 3
      org.quartz.scheduler.periodic.prefetch: 2
      org.quartz.scheduler.ondemand.maxthreads: 4
      org.quartz.scheduler.ondemand.prefetch: 4
    volumes:
    - {type: tmpfs, target: /opt/blackduck/hub/jobrunner/security}
    deploy:
      mode: replicated
      restart_policy: {condition: on-failure, delay: 5s, window: 60s}
  cfssl:
    image: blackducksoftware/blackduck-cfssl:1.0.34
    volumes: ['cert-volume:/etc/cfssl']
    env_file: [blackduck-config.env]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'http://localhost:8888/api/v1/cfssl/scaninfo']
      interval: 30s
      timeout: 10s
      retries: 5
    user: cfssl:root
    deploy:
      mode: replicated
      restart_policy: {condition: on-failure, delay: 5s, window: 60s}
  logstash:
    image: blackducksoftware/blackduck-logstash:1.0.45
    volumes: ['log-volume:/var/lib/logstash/data']
    env_file: [blackduck-config.env]
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'http://localhost:9600/']
      interval: 30s
      timeout: 10s
      retries: 5
    user: logstash:root
    environment:
       DAYS_TO_KEEP_LOGS: 30
    deploy:
      mode: replicated
      restart_policy: {condition: on-failure, delay: 5s, window: 60s}
  registration:
    image: blackducksoftware/blackduck-registration:2025.10.0
    volumes:
    - config-volume:/opt/blackduck/hub/hub-registration/config
    - {type: tmpfs, target: /opt/blackduck/hub/hub-registration/security}
    env_file: [blackduck-config.env , hub-postgres.env]
    environment:
      << : *common-env-settings
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/registration/health-checks/liveness',
        /opt/blackduck/hub/hub-registration/security/root.crt, /opt/blackduck/hub/hub-registration/security/blackduck_system.crt,
        /opt/blackduck/hub/hub-registration/security/blackduck_system.key]
      interval: 30s
      timeout: 10s
      retries: 5
    user: registration:root
    deploy:
      mode: replicated
      restart_policy: {condition: on-failure, delay: 5s, window: 60s}
  webserver:
    image: blackducksoftware/blackduck-nginx:2025.10.0
    ports: ['443:8443']
    env_file: [hub-webserver.env, blackduck-config.env]
    environment:
       << : *host-settings
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/health-checks/liveness',
        /opt/blackduck/hub/webserver/security/root.crt]
      interval: 30s
      timeout: 10s
      retries: 5
    user: nginx:root
    volumes:
    - {type: tmpfs, target: /opt/blackduck/hub/webserver/security}
    deploy:
      mode: replicated
      restart_policy: {condition: on-failure, delay: 15s, window: 60s}

  documentation:
    image: blackducksoftware/blackduck-documentation:2025.10.0
    env_file: [blackduck-config.env]
    user: documentation:root
    environment:
      << : *host-settings
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://127.0.0.1:8443/hubdoc/health-checks/liveness',
        /opt/blackduck/hub/hub-documentation/security/root.crt]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
    - {type: tmpfs, target: /opt/blackduck/hub/hub-documentation/security}
    deploy:
      mode: replicated
      restart_policy: {condition: on-failure, delay: 5s, window: 60s}
  redis:
    image: blackducksoftware/blackduck-redis:2025.10.0
    env_file: [blackduck-config.env]
    environment:
      << : *host-settings
    user: redis:root
    stop_grace_period: 60s
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, '8379',
        /opt/blackduck/hub/blackduck-redis/security/root.crt,
        /opt/blackduck/hub/blackduck-redis/security/blackduck_system.crt,
        /opt/blackduck/hub/blackduck-redis/security/blackduck_system.key]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
    - {type: tmpfs, target: /opt/blackduck/hub/blackduck-redis/security}
    deploy:
      restart_policy: {condition: any}
  bomengine:
    image: blackducksoftware/blackduck-bomengine:2025.10.0
    env_file: [blackduck-config.env , hub-postgres.env]
    environment:
      << : *common-env-settings
    healthcheck:
      test: [CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/api/health-checks/liveness',
        /opt/blackduck/hub/blackduck-bomengine/security/root.crt, /opt/blackduck/hub/blackduck-bomengine/security/blackduck_system.crt,
        /opt/blackduck/hub/blackduck-bomengine/security/blackduck_system.key]
      interval: 30s
      timeout: 60s
      retries: 15
      << : *long-start-period
    user: bomengine:root
    volumes:
      - { type: tmpfs, target: /opt/blackduck/hub/blackduck-bomengine/security }
    deploy:
        mode: replicated
        restart_policy: {condition: on-failure, delay: 5s, window: 60s}
  scanmatch:
    image: blackducksoftware/blackduck-scanmatch:2025.10.0
    user: scanmatch:root
    healthcheck:
      test: [ CMD, /usr/local/bin/docker-healthcheck.sh, 'https://localhost:8443/api/health-checks/liveness',
              /opt/blackduck/hub/blackduck-scanmatch/security/root.crt, /opt/blackduck/hub/blackduck-scanmatch/security/blackduck_system.crt,
              /opt/blackduck/hub/blackduck-scanmatch/security/blackduck_system.key ]
      interval: 30s
      timeout: 60s
      retries: 15
      << : *long-start-period
    env_file: [ blackduck-config.env , hub-postgres.env ]
    volumes:
      - { type: tmpfs, target: /opt/blackduck/hub/blackduck-scanmatch/security }
    deploy:
      mode: replicated
      restart_policy: { condition: on-failure, delay: 5s, window: 60s }
    environment:
      << : *common-env-settings
  rabbitmq:
    image: blackducksoftware/rabbitmq:1.2.48
    hostname: rabbitmq
    volumes: 
      - rabbitmq-data-volume:/var/lib/rabbitmq
      - {type: tmpfs, target: /opt/blackduck/rabbitmq/security}
    environment: {
      BLACKDUCK_RABBIT_SCAOP: 'true'
    }
    env_file: [blackduck-config.env]
    healthcheck:
      test: [CMD, rabbitmq-diagnostics, -q, status]
      interval: 30s
      timeout: 10s
      retries: 5
    user: rabbitmq:root
    deploy:
        mode: replicated
        restart_policy: {condition: any, delay: 5s, window: 60s}
volumes: {postgres96-data-volume: null, authentication-volume: null, cert-volume: null,
  config-volume: null, log-volume: null, storage-volume: null, rabbitmq-data-volume: null }
